<!DOCTYPE html>
<head></head>
<body>
	<input type="file" id="file" placeholder="Connecting to the peers, please wait"></input>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.6.2/simplepeer.min.js"></script>
	<script>
		var p;
		$(function () {
			var socket = io();
			socket.emit("bump", { time: Date.now() });

			socket.on("bumped", function (data) {
				console.log(data);

				p = new SimplePeer({
					initiator: data.initiator,
					trickle: false,
				});

				p.on("error", (err) => console.log("error", err));

				p.on("signal", (offer) => {
					console.log("SIGNAL", JSON.stringify(offer));
					socket.emit("p2p", { offer: JSON.stringify(offer), recipient: data.recipient });
				});

				socket.on("p2p", function (data) {
					p.signal(JSON.parse(data.offer));

					p.on("connect", () => {
						console.log("CONNECT");
						p.send("whatever" + Math.random());
					});

					p.on("data", (data) => {
						// Convert the file back to Blob
							const file = new Blob([ data ]);

						console.log('Received', file);
						// Download the received file using downloadjs
						//download(file, 'test.png');
					});
				});
			});
		});

		const input = document.getElementById('file');

  // Event listener on the file input
  input.addEventListener('change', () => {
    const file = input.files[0];
    console.log('Sending', file)

    // We convert the file from Blob to ArrayBuffer, since some browsers don't work with blobs
    file.arrayBuffer()
    .then(buffer => {
      // Off goes the file!
      p.send(buffer);
    });

  });
	</script>
</body>
